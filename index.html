<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>×™×•××Ÿ ×ª×–×•× ×”</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
    />
    <link
            href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="foodlogger.css" />
    <!--<style>

    </style> -->
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<body>
<!-- App Container with 3 pages -->
<div class="app-container" id="appContainer">
    <!-- Page 1: Meals Library -->
    <div class="page">
        <div class="popup-backdrop d-none" id="bgFocus"></div>
        <!-- Header -->
        <div class="header">
            <div
                    class="container-fluid d-flex align-items-center justify-content-between"
            >
                <h1 class="h3 mb-0 text-center">×™×•××Ÿ ×ª×–×•× ×”</h1>
                <button
                        type="button"
                        class="btn btn-outline-danger btn-sm"
                        id="resetDatabaseBtn"
                        onclick="resetDatabase()"
                >
                    ××™×¤×•×¡
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container-fluid px-3">
            <!-- Search Bar -->
            <div class="search-container mb-3">
                <div class="input-group">
                    <input
                            type="text"
                            class="form-control border-start-0 ps-0"
                            id="searchInput"
                            placeholder="×—×¤×© ××¨×•×—×”..."
                            onkeyup="filterMeals()"
                    />
                    <button
                            class="btn btn-outline-secondary"
                            type="button"
                            id="clearSearch"
                            onclick="clearSearch()"
                            style="display: none;"
                    >
                        X
                    </button>
                </div>
            </div>

            <!-- Meal Cards Grid (loaded from database) -->
            <div class="row g-2" id="mealsGrid">
                <!-- Meals will be loaded from database -->
            </div>

            <!-- No Results Message -->
            <div id="noResultsMessage" class="no-results" style="display: none;">
                <i class="fas fa-search"></i>
                <div>×œ× × ××¦××• ××¨×•×—×•×ª ×”×ª×•×××•×ª ×œ×—×™×¤×•×©</div>
                <small>× ×¡×” ×œ×—×¤×© ×‘××™×œ×™× ××—×¨×•×ª</small>
            </div>
        </div>
    </div>

    <!-- Page 2: Today's Summary -->
    <div class="page">
        <div class="header">
            <div class="container-fluid">
                <h1 class="h3 mb-0 text-center">×”×™×•×</h1>
            </div>
        </div>

        <div class="container-fluid px-3">
            <div class="daily-summary">
                <!--   <div class="date-header">
                  <i class="fas fa-calendar me-2"></i>
                  ×™×•× ×¨××©×•×Ÿ, 22 ×™×•× ×™ 2025
                </div> -->

                <div class="nutrition-summary over-goal">
                    <div class="nutrition-row">
                        <div class="nutrition-value over-goal">1,700</div>
                        <div class="nutrition-label">×§×œ×•×¨×™×•×ª</div>
                    </div>
                    <div class="nutrition-row">
                        <div class="nutrition-value">80</div>
                        <div class="nutrition-label">×¤×—××™××•×ª</div>
                    </div>
                    <div class="nutrition-row">
                        <div class="nutrition-value">80</div>
                        <div class="nutrition-label">×—×œ×‘×•× ×™×</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 3: Yesterday's Summary -->

    <div class="page">This IS PAGE</div>
</div>
<!-- APP CONTAINER -->

<!-- Bottom Tab Navigation -->
<div class="bottom-tabs">
    <ul class="tabs">
        <li class="tab active" onclick="switchTab(0)">
            <i class="fas fa-utensils"></i>
            <span>××¨×•×—×•×ª</span>
        </li>
        <li class="tab" onclick="switchTab(1)">
            <i class="fas fa-calendar-day"></i>
            <span>×”×™×•×</span>
        </li>
        <li class="tab" onclick="switchTab(2)">
            <i class="fas fa-calendar-week"></i>
            <span>×©×‘×•×¢×™</span>
        </li>
    </ul>
</div>

<!-- Floating Add Button (only visible on meals page) -->
<button
        class="btn btn-warning add-btn d-flex align-items-center justify-content-center"
        id="addBtn"
        data-bs-toggle="modal"
        data-bs-target="#addMealModal"
>
    <i class="fas fa-plus fa-lg"></i>
</button>

<!-- Add Meal Modal -->
<div
        class="modal fade"
        id="addMealModal"
        tabindex="-1"
        aria-labelledby="addMealModalLabel"
        aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!--   <div class="modal-header">
              <h1 class="modal-title fs-5" id="addMealModalLabel" data-bs-dismiss="modal">
                ×”×•×¡×£ ××¨×•×—×” ×—×“×©×”
          </h1>
            </div>-->
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <input
                                type="text"
                                class="form-control"
                                id="mealName"
                                placeholder="×©× ×”××¨×•×—×”"
                        />
                    </div>
                    <div class="mb-3">
                        <input
                                type="file"
                                class="camera-input"
                                id="mealImageInput"
                                accept="image/*"
                                capture="environment"
                                onchange="handleImageCapture(this)"
                        />
                        <div
                                class="camera-btn"
                                onclick="document.getElementById('mealImageInput').click()"
                                id="cameraButton"
                        >
                            <div class="text-center">
                                <i class="fas fa-camera fa-2x mb-2"></i>
                                <div>×œ×—×¥ ×œ×¦×™×œ×•×</div>
                                <small>××• ×‘×—×¨ ×ª××•× ×” ××”×’×œ×¨×™×”</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                <textarea
                        class="form-control"
                        id="ingredients"
                        rows="4"
                        placeholder="×ª××¨ ××ª ×”××¨×›×™×‘×™×..."
                ></textarea>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="calories" class="form-label">×§×œ×•×¨×™×•×ª</label>
                            <input
                                    type="number"
                                    class="form-control"
                                    id="calories"
                                    placeholder="0"
                            />
                        </div>
                        <div class="col-4">
                            <label for="carbs" class="form-label">×¤×—××™××•×ª</label>
                            <input
                                    type="number"
                                    class="form-control"
                                    id="carbs"
                                    placeholder="0"
                            />
                        </div>
                        <div class="col-4">
                            <label for="carbs" class="form-label">×—×œ×‘×•× ×™×</label>
                            <input
                                    type="number"
                                    class="form-control"
                                    id="protein"
                                    placeholder="0"
                            />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                >
                    ×‘×™×˜×•×œ
                </button>
                <button
                        type="button"
                        class="btn btn-primary"
                        onclick="addNewMeal()"
                >
                    ×©××•×¨ ××¨×•×—×”
                </button>
                <button
                        type="button"
                        class="btn btn-primary"
                        onclick="saveQuickLog()"
                >
                    ×§×•×•×™×§×™
                </button>
                <button
                        type="button"
                        class="btn btn-success"
                        onclick="calcNewMeal()"
                        style="background: var(--secondary-color); border: none; "
                >
                    ×—×™×©×•×‘ ××•×˜×•××˜×™
                </button>
            </div>
        </div>
    </div>
</div>

<script src="foodloggerDB.js" defer></script>

<script>

    /* ---- your original inline code, almost verbatim ---- */
    let currentPage = 0;
    let db = null;

    async function initializeApp() {
        db = new FoodLoggerDB();
        await db.init();
        await loadMealsFromDB();
        console.log('âœ… App initialised (module mode)');
    }



    // Load meals from database and display in UI
    async function loadMealsFromDB() {
        try {
            const meals = await db.getMeals();
            const mealsGrid = document.getElementById('mealsGrid');
            let bg = document.getElementById('bgFocus');
            if (bg) {
                bg.classList.add('d-none');
            }

            // Clear existing content
            mealsGrid.innerHTML = '';

            if (meals.length === 0) {
                // Show empty state
                mealsGrid.innerHTML = `
                                        <div class="col-12">
                                            <div class="text-center py-5">
                                                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                                                <h4 class="text-muted">××™×Ÿ ××¨×•×—×•×ª ×¢×“×™×™×Ÿ</h4>
                                                <p class="text-muted">×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”-+ ×›×“×™ ×œ×”×•×¡×™×£ ××ª ×”××¨×•×—×” ×”×¨××©×•× ×” ×©×œ×š</p>
                                            </div>
                                        </div>
                                    `;
            } else {
                // Create meal cards
                meals.forEach(meal => {
                    const cardHtml = createMealCard(meal);
                    mealsGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
            }

            console.log(`Loaded ${meals.length} meals from database`);
        } catch (error) {
            console.error('Error loading meals:', error);
        }
    }

    // Create HTML for a meal card
    function createMealCard(meal) {
        return `
                                <div class="col-4">
                                    <div class="meal-card"  data-meal-id="${meal.id}" data-usage="${meal.usageCount}">
                                        <div class="card-closed" style="background-image: url('${meal.image}');" onclick="toggleCard(this.parentElement)">
                                            <div class="expand-icon">
                                                <i class="fas fa-chevron-down"></i>
                                            </div>
                                            <div class="card-overlay">
                                                <h5 class="meal-title">${meal.name}</h5>
                                                <div class="card-stats">
                                                    <span class="usage-counte">
                                                        ${meal.calories} ×§×œ×•×¨×™×•×ª
                                                    </span>
                                                    <span class="usage-counter">
                                                        ${meal.usageCount} ×¤×¢××™×
                                                    </span>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMeal('${meal.id}', '${meal.name}')">X</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card-details">
                                            <div class="card-details-content">
                                                <p class="ingredients-text">
                                                    ${meal.ingredients}
                                                </p>
                                                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                                                    <!--<span class="badge bg-primary stats-badge">
                                                        ${meal.calories} ×§×œ×•×¨×™×•×ª
                                                    </span>-->
                                                    <span class="badge bg-success stats-badge">
                                                        ${meal.carbs} ×’×¨× ×¤×—××™××•×ª
                                                    </span>
                                                    <span class="badge bg-info stats-badge">
                                                        ${meal.protein} ×’×¨× ×—×œ×‘×•×Ÿ
                                                    </span>
                                                </div>
                                                <button class="btn eat-now-btn" onclick="eatNow(event, '${meal.id}', '${meal.name}', ${meal.calories})">
                                                    ××›×œ×ª×™ ×¢×›×©×™×•
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
    }

    // Convert file to compressed base64
    function compressAndConvertImage(file, maxWidth = 400, quality = 0.7) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // Calculate new dimensions
                let { width, height } = img;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                // Set canvas size
                canvas.width = width;
                canvas.height = height;

                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);

                // Convert to compressed base64
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedBase64);
            };

            // Create object URL for the image
            img.src = URL.createObjectURL(file);
        });
    }



    /* ----------------------------------------------------------
Central configuration â€“ put this near the top of your main
script (or import from a separate config.js).
---------------------------------------------------------- */
    const CONFIG = {
        AI_ENDPOINT: 'https://openai-backend-k753.onrender.com/ask'
    };

    /* ----------------------------------------------------------
       Nutrition-AI helper â€“ keeps fetch logic out of the UI code.
    ---------------------------------------------------------- */
    async function estimateNutrition(ingredientsText) {
        const prompt = `
              ×”×¢×¨×š ×”×ª×–×•× ×ª×™ ×©×œ ×”××¨×•×—×” ×”×‘××”: ${ingredientsText}.
              ×”×—×–×¨ ×¨×§ ×©×œ×•×©×” ××¡×¤×¨×™× ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™× â€“
              ×§×œ×•×¨×™×•×ª, ×¤×—××™××•×ª ×‘×’×¨×, ×—×œ×‘×•×Ÿ ×‘×’×¨×.
              ×œ××©×œ: 450, 12, 22
              ×œ×œ× ×˜×§×¡×˜ × ×•×¡×£.
            `.trim();

        const res = await fetch(CONFIG.AI_ENDPOINT, {
            method : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body   : JSON.stringify({ question: prompt })
        });

        if (!res.ok) {
            const { error, detail } = await res.json().catch(() => ({}));
            throw new Error(error || detail || `HTTP ${res.status}`);
        }

        const data = await res.json();

        /*  Two supported response shapes:
              1. { calories:123, carbs:12, protein:22 }
              2. { answer: "123, 12, 22" }
        */
        if (typeof data.calories === 'number') {
            return data;                // shape #1
        }

        const match = (data.answer || '').match(/([\d.]+)[, ]+([\d.]+)[, ]+([\d.]+)/);
        if (!match) throw new Error('×ª×‘× ×™×ª ×ª×©×•×‘×” ×œ× × ×ª××›×ª');

        return {
            calories: parseFloat(match[1]),
            carbs   : parseFloat(match[2]),
            protein : parseFloat(match[3])
        };
    }

    /* ----------------------------------------------------------
       calcNewMeal â€“ UI layer: disables button, calls helper,
       fills the form, and always restores state.
    ---------------------------------------------------------- */
    async function calcNewMeal(btnEl = document.activeElement) {
        const ingredients = document.getElementById('ingredients').value.trim();
        if (!ingredients) { alert('××™×Ÿ ××¨×›×™×‘×™×'); return; }

        // fall-back in case function called from inline onclick
        if (!btnEl || !btnEl.classList.contains('btn')) {
            btnEl = document.querySelector('#addMealModal .btn-success');
        }

        /* ----- loading state ----- */
        const originalHTML = btnEl.innerHTML;
        btnEl.innerHTML   = '<i class="fas fa-spinner fa-spin me-1"></i> ××—×©×‘...';
        btnEl.disabled    = true;

        try {
            const { calories, carbs, protein } = await estimateNutrition(ingredients);

            /*  populate inputs  */
            document.getElementById('calories').value = calories;
            document.getElementById('carbs').value    = carbs;
            document.getElementById('protein').value  = protein;

        } catch (err) {
            console.error(err);
            alert(`âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ×”×¢×¨×›×™×:\n${err.message}`);
        } finally {
            /* ----- restore button ----- */
            btnEl.innerHTML = originalHTML;
            btnEl.disabled  = false;
        }
    }


    async function deleteMeal(mealId, mealName) {
        // Show confirmation dialog
        const confirmed = confirm(
            `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××¨×•×—×”?\n\n` +
            `"${mealName}"\n\n` +
            `×¤×¢×•×œ×” ×–×• ×ª××—×§:\n` +
            `â€¢ ××ª ×”××¨×•×—×” ××”×¡×¤×¨×™×™×”\n` +
            `â€¢ ××ª ×›×œ ×”×¨×™×©×•××™× ×©×œ ×”××¨×•×—×” ×”×–×•\n\n` +
            `×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ×¤×¢×•×œ×” ×–×•!`
        );

        if (!confirmed) return;

        try {
            // Show loading state on delete button
            const deleteBtn = document.querySelector(`[onclick="deleteMeal('${mealId}', '${mealName}')"]`);
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>××•×—×§...';
            }

            // Delete from database
            await db.deleteMeal(mealId);

            // Also delete all daily logs for this meal
            await db.deleteAllLogsForMeal(mealId);

            // Reload meals to update UI
            await loadMealsFromDB();

            // Show success message
            console.log(`âœ… Deleted meal: ${mealName}`);

            // Close any expanded cards since the meal is gone
            document.querySelectorAll('.meal-card.expanded').forEach(card => {
                const details = card.querySelector('.card-details');
                const icon = card.querySelector('.expand-icon i');

                details.classList.remove('show');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                card.classList.remove('expanded');
            });

        } catch (error) {
            console.error('âŒ Error deleting meal:', error);
            alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”××¨×•×—×”. × ×¡×” ×©×•×‘.');

            // Restore button state on error
            const deleteBtn = document.querySelector(`[onclick="deleteMeal('${mealId}', '${mealName}')"]`);
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-trash me-2"></i>××—×§ ××¨×•×—×”';
            }
        }
    }
    async function saveQuickLog() {
        const name  = document.getElementById('mealName').value.trim();
        const cal   = parseInt(document.getElementById('calories').value) || 0;
        const carb  = parseInt(document.getElementById('carbs').value) || 0;
        const prot  = parseInt(document.getElementById('protein').value) || 0;

        if (cal <= 0) { alert('×”×›× ×¡ ×§×œ×•×¨×™×•×ª'); return; }

        try {
            await db.quickLog(name, cal, carb, prot);

            const modal = bootstrap.Modal.getInstance(document.getElementById('addMealModal'));
            modal.hide();
            resetAddMealForm();

            // Show success message
            console.log('âœ… Added new meal:', name);
            // refresh today's view
            await loadDayData();

        } catch (e) {
            alert('×©×’×™××” ×‘×¨×™×©×•×');  console.error(e);
        }

    }

    // Add new meal to database
    async function addNewMeal() {
        const name = document.getElementById('mealName').value.trim();
        const ingredients = document.getElementById('ingredients').value.trim();
        const calories = parseInt(document.getElementById('calories').value) || 0;
        const carbs = parseInt(document.getElementById('carbs').value) || 0;
        const protein = parseInt(document.getElementById('protein').value) || 0;
        const imageInput = document.getElementById('mealImageInput');

        if (!name) {
            alert('×× × ××œ× ××ª ×©× ×”××¨×•×—×”');
            return;
        }

        if (!ingredients) {
            alert('×× × ×ª××¨ ××ª ××¨×›×™×‘×™ ×”××¨×•×—×”');
            return;
        }

        if (calories <= 0) {
            alert('×× × ×”×›× ×¡ ××¡×¤×¨ ×§×œ×•×¨×™×•×ª ×ª×§×™×Ÿ');
            return;
        }

        try {
            // Show loading state
            const saveBtn = document.querySelector('#addMealModal .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>×©×•××¨...';
            saveBtn.disabled = true;

            let imageData = 'placeholder.png'; //`https://picsum.photos/400/400?random=${Date.now()}`; // Default placeholder DISABLED PLACEHOLER IMAGE

            // If user selected an image, compress and convert to base64
            if (imageInput.files && imageInput.files[0]) {
                const file = imageInput.files[0];

                // Check file size (warn if over 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    console.warn('Large image file, compressing...');
                }

                imageData = await compressAndConvertImage(file, 400, 0.7);
                console.log(`Image compressed from ${Math.round(file.size/1024)}KB to ${Math.round(imageData.length*0.75/1024)}KB`);
            }

            // Add to database
            const meal = await db.addMeal(name, imageData, ingredients, calories, carbs, protein);

            // Reload meals in UI
            await loadMealsFromDB();

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addMealModal'));
            modal.hide();
            resetAddMealForm();

            // Show success message
            console.log('âœ… Added new meal:', meal.name);

            // Restore button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

        } catch (error) {
            console.error('âŒ Error adding meal:', error);
            alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×”××¨×•×—×”. × ×¡×” ×©×•×‘.');

            // Restore button state
            const saveBtn = document.querySelector('#addMealModal .btn-primary');
            saveBtn.innerHTML = '×©××•×¨ ××¨×•×—×”';
            saveBtn.disabled = false;
        }
    }

    // Reset the add meal form
    function resetAddMealForm() {
        document.querySelector('#addMealModal form').reset();
        const cameraButton = document.getElementById('cameraButton');
        cameraButton.innerHTML = `
                                <div class="text-center">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <div>×œ×—×¥ ×œ×¦×™×œ×•×</div>
                                    <small>××• ×‘×—×¨ ×ª××•× ×” ××”×’×œ×¨×™×”</small>
                                </div>
                            `;
        cameraButton.classList.remove('has-image');
    }

    function switchTab(pageIndex) {
        currentPage = pageIndex;

        // Update tab active state
        document.querySelectorAll('.tab').forEach((tab, index) => {
            if (index === pageIndex) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });

        // Move to the page
        const container = document.getElementById('appContainer');

        const page = container.querySelectorAll('.page')[pageIndex];
        page.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
        window.scrollTo(0, 0);

        //        container.style.transform = `translateX(${pageIndex * 100}vw)`;

        // Show/hide add button based on page
        const addBtn = document.getElementById('addBtn');
        if (pageIndex === 0) {
            addBtn.style.display = 'flex';
        } else {
            addBtn.style.display = 'none';
        }

        if (pageIndex === 1) {
            loadDayData();
        } else if (pageIndex === 2) {
            loadWeeklyOverview();
            //loadDayData('yesterday');
        }
        // Load daily summary data for summary pages
        //loadDailySummary(pageIndex);
    }

    function toggleCard(card) {
        console.log('toggleCard called from:', card);
        const details = card.querySelector('.card-details');
        const icon = card.querySelector('.expand-icon i');

        // Toggle the expanded state
        if (details.classList.contains('show')) {
            details.classList.remove('show');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            card.classList.remove('expanded');
            document.getElementById('bgFocus').classList.add('d-none');
        } else {
            // Close all other cards first
            document.querySelectorAll('.card-details.show').forEach(detail => {
                detail.classList.remove('show');
            });
            document.querySelectorAll('.expand-icon i').forEach(expandIcon => {
                expandIcon.classList.remove('fa-chevron-up');
                expandIcon.classList.add('fa-chevron-down');
            });
            document.querySelectorAll('.meal-card.expanded').forEach(expandedCard => {
                expandedCard.classList.remove('expanded');
            });

            // Open this card
            document.getElementById('bgFocus').classList.remove('d-none');
            details.classList.add('show');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            card.classList.add('expanded');
        }
    }

    async function eatNow(event, mealId, mealName, calories) {
        //event.stopPropagation(); // Prevent card from closing

        if (!db) {
            console.error('Database not initialized');
            return;
        }

        try {
            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>××•×¡×™×£...';
            btn.disabled = true;

            // Log the meal
            const logEntry = await db.eatMeal(mealId);

            // Show success state
            btn.innerHTML = '<i class="fas fa-check me-2"></i>× ×•×¡×£!';
            btn.style.background = '#28a745';



            console.log(`âœ… Logged: ${mealName} (${calories} calories) at ${logEntry.time}`);

            // Reset button after 2 seconds
            setTimeout(async () => {
                // btn.innerHTML = originalText;
                // btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                // btn.disabled = false;
                // Update usage count in UI by reloading meals
                await loadMealsFromDB();
            }, 1000);

        } catch (error) {
            console.error('âŒ Error logging meal:', error);

            // Show error state
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-times me-2"></i>×©×’×™××”';
            btn.style.background = '#dc3545';

            setTimeout(() => {
                btn.innerHTML = `<i class="fas fa-plus me-2"></i>××›×œ×ª×™ ×¢×›×©×™×•`;
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btn.disabled = false;
            }, 2000);
        }
    }

    async function filterMeals() {
        const searchInput = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearSearch');
        const searchTerm = searchInput.value.trim();
        const noResultsMessage = document.getElementById('noResultsMessage');

        // Show/hide clear button
        if (searchTerm.length > 0) {
            clearButton.style.display = 'block';
        } else {
            clearButton.style.display = 'none';
        }

        // Only filter after 2 characters
        if (searchTerm.length < 2) {
            // Show all meals
            await loadMealsFromDB();
            noResultsMessage.style.display = 'none';
            return;
        }

        try {
            // Search in database
            const meals = await db.searchMeals(searchTerm);
            const mealsGrid = document.getElementById('mealsGrid');

            // Clear and show results
            mealsGrid.innerHTML = '';

            if (meals.length === 0) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
                meals.forEach(meal => {
                    const cardHtml = createMealCard(meal);
                    mealsGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
        } catch (error) {
            console.error('Search error:', error);
            // Show no results if search fails
            document.getElementById('mealsGrid').innerHTML = '';
            noResultsMessage.style.display = 'block';
        }
    }

    async function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearSearch');

        searchInput.value = '';
        clearButton.style.display = 'none';

        // Show all meals
        await loadMealsFromDB();
        document.getElementById('noResultsMessage').style.display = 'none';
        searchInput.focus();
    }

    function handleImageCapture(input) {
        const button = document.getElementById('cameraButton');

        if (input.files && input.files[0]) {
            const fileName = input.files[0].name;
            button.innerHTML = `
                                    <div class="text-center">
                                        <i class="fas fa-check-circle fa-2x mb-2" style="color: var(--success-color);"></i>
                                        <div>×ª××•× ×” × ×‘×—×¨×”</div>
                                        <small>${fileName}</small>
                                    </div>
                                `;
            button.classList.add('has-image');
        }
    }

    async function loadDayData() {
        if (!db) return;

        try {
            // Calculate target date
            const today = new Date();
            let targetDate, pageIndex;
            targetDate = today.toISOString().split('T')[0];
            pageIndex = 1;

            // Get data from database
            const [totals, meals] = await Promise.all([
                db.getDayTotals(targetDate),
                db.getDayMeals(targetDate)
            ]);

            // Find the target page element
            const pageElement = document.querySelector(`.page:nth-child(${pageIndex + 1})`);
            if (!pageElement) {
                console.error(`Page element not found for Today`);
                return;
            }

            // Update page header
            const pageHeader = pageElement.querySelector('.header h1');
            if (pageHeader) {
                pageHeader.innerHTML = `
                                ×”×™×•×
                            `;
            }

            // Update date header
            /*const dateHeader = pageElement.querySelector('.date-header');
            if (dateHeader) {
                const formattedDate = formatHebrewDate(targetDate);
                dateHeader.innerHTML = `
                    <i class="fas fa-calendar me-2"></i>
                    ${formattedDate}
                `;
            }*/

            // Update nutrition summary
            // pageElement.querySelector('.daily-summary').innerHTML=""; //RESET DAILY DATA;

            const nutritionSummary = pageElement.querySelector('.nutrition-summary');
            if (nutritionSummary) {
                const isOverGoal = totals.calories > db.DAILY_GOAL;

                // Update CSS classes for color coding
                if (isOverGoal) {
                    nutritionSummary.classList.add('over-goal');
                } else {
                    nutritionSummary.classList.remove('over-goal');
                }

                // Update nutrition content
                nutritionSummary.innerHTML = `
                                <div class="nutrition-row">
                                    <div class="nutrition-value ${isOverGoal ? 'over-goal' : ''}">${totals.calories}</div>
                                    <div class="nutrition-label">
                                    ××ª×•×š ${db.DAILY_GOAL }
                                    </div>

                                </div>
                                <div class="nutrition-row">
                                    <div class="nutrition-value">${totals.carbs}</div>
                                    <div class='nutrition-label'>×¤×—××™××•×ª</div>
                                </div>
                                <div class="nutrition-row">
                                    <div class="nutrition-value">${totals.protein}</div>
                                    <div class='nutrition-label'>×—×œ×‘×•× ×™×</div>
                                </div>
                            `;
            }

            // Update meals list
            const dailySummary = pageElement.querySelector('.daily-summary');
            if (dailySummary) {
                // Remove existing meal items
                const existingMeals = dailySummary.querySelectorAll('.meal-item');
                existingMeals.forEach(item => item.remove());
                //dailySummary.innerHTML="";

                if (meals.length === 0) {
                    // Show empty state
                    const emptyState = document.createElement('div');
                    emptyState.className = 'text-center py-4 text-muted';
                    emptyState.innerHTML = `
                                    <div class="mb-3">
                                        <i class="fas fa-utensils fa-3x text-muted"></i>
                                    </div>
                                    <h5 class="text-muted">×œ× × ×¨×©××• ××¨×•×—×•×ª ×”×™×•×</h5>

                                `;
                    dailySummary.innerHTML=emptyState;
                } else {
                    // Add meal items
                    meals.forEach((meal, index) => {
                        const mealItem = document.createElement('div');
                        mealItem.className = 'meal-item';
                        mealItem.style.animationDelay = `${index * 0.1}s`; // Stagger animation

                        mealItem.innerHTML = `
                                        <div class="meal-item-header">
                                            <span class="meal-time">${meal.time}</span>
                                            <span class="meal-name">${meal.mealName}</span>

                                            <button
                                              class="btn btn-outline-danger btn-sm"
                                              onclick="deleteLoggedFood('${meal.id}', '${meal.mealName}')"
                                              title="××—×§ ×¨×™×©×•× ×–×”"
                                              style="padding: 0.2rem 0.4rem; font-size: 0.7rem; margin-inline-start: auto;">
                                              <i class="fas fa-times"></i>
                                          </button>
                                        </div>

                                        <div class="meal-nutrition mt-2">
                                            <small class="text-muted">

                                               ${meal.calories} ×§×œ×•×¨×™×•×ª | ${meal.carbs} ×¤×—××™××•×ª | ${meal.protein} ×—×œ×‘×•× ×™×
                                            </small>
                                        </div>
                                    `;

                        dailySummary.appendChild(mealItem);
                    });

                    // Add summary footer
                    /*/const summaryFooter = pageElement.querySelector('.footer-summary');
                    //summaryFooter.innerHTML="";
                    //summaryFooter.className = 'mt-4 p-3 bg-light rounded text-center';
                    summaryFooter.innerHTML = `
                        <small class="text-muted">
                            <strong>${meals.length}</strong> ××¨×•×—×•×ª × ×¨×©××• ${dayType === 'today' ? '×”×™×•×' : '××ª××•×œ'}
                        </small>
                    `;
                    dailySummary.appendChild(summaryFooter); */
                }
            }

            console.log(`âœ… Loaded today data: ${totals.calories} calories, ${meals.length} meals`);

        } catch (error) {
            console.error(`âŒ Error loading ${dayType} data:`, error);

            // Show error state
            //const pageElement = document.querySelector(`.page:nth-child(${dayType === 'today' ? 2 : 3})`);
            //const dailySummary = pageElement?.querySelector('.daily-summary');
            if (dailySummary) {
                dailySummary.innerHTML = `
                                <div class="text-center py-4 text-danger">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                    <div>×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</div>
                                    <small>× ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£</small>
                                </div>
                            `;
            }
        }
    }

    // Helper function for Hebrew date formatting
    function formatHebrewDate(dateString) {
        const date = new Date(dateString);
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        const months = [
            '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
            '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
        ];

        const dayName = days[date.getDay()];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();

        return `×™×•× ${dayName}, ${day} ${month} ${year}`;
    }

    // Helper function (already exists in your code)
    function getMealTypeInHebrew(time) {
        const hour = parseInt(time.split(':')[0]);

        if (hour >= 5 && hour < 11) return '××¨×•×—×ª ×‘×•×§×¨';
        if (hour >= 11 && hour < 15) return '××¨×•×—×ª ×¦×”×¨×™×™×';
        if (hour >= 15 && hour < 18) return '×—×˜×™×£ ××—×¨ ×”×¦×”×¨×™×™×';
        if (hour >= 18 && hour < 22) return '××¨×•×—×ª ×¢×¨×‘';
        return '×—×˜×™×£';
    }


    async function resetDatabase() {
        // Show confirmation dialog
        const confirmed = confirm(
            'âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?\n\n' +
            '×¤×¢×•×œ×” ×–×• ×ª××—×§:\n' +
            'â€¢ ××ª ×›×œ ×”××¨×•×—×•×ª ×‘×¡×¤×¨×™×™×”\n' +
            'â€¢ ××ª ×›×œ ×”×¨×™×©×•××™× ×©×œ ××¨×•×—×•×ª ×©× ××›×œ×•\n' +
            'â€¢ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×ª×–×•× ×ª×™×™×\n\n' +
            '×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ×¤×¢×•×œ×” ×–×•!'
        );

        if (!confirmed) return;

        // Double confirmation for safety
        const doubleConfirmed = confirm(
            'ğŸš¨ ××™×©×•×¨ ××—×¨×•×Ÿ!\n\n' +
            '×œ×—×¥ OK ×›×“×™ ×œ××—×•×§ ×œ×¦××™×ª×•×ª ××ª ×›×œ ×”× ×ª×•× ×™×.\n' +
            '×œ×—×¥ Cancel ×›×“×™ ×œ×‘×˜×œ.'
        );

        if (!doubleConfirmed) return;

        try {
            // Show loading state
            const resetBtn = document.getElementById('resetDatabaseBtn');
            if (resetBtn) {
                resetBtn.disabled = true;
                resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>××•×—×§...';
            }

            // Clear all database data
            await db.clearAllData();

            // Reload the meals page to show empty state
            await loadMealsFromDB();

            // Show success message
            alert('âœ… ×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”!');

            console.log('ğŸ”„ Database reset completed');

        } catch (error) {
            console.error('âŒ Error resetting database:', error);
            alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”× ×ª×•× ×™×. × ×¡×” ×©×•×‘.');
        } finally {
            // Restore button state
            const resetBtn = document.getElementById('resetDatabaseBtn');
            if (resetBtn) {
                resetBtn.disabled = false;
                resetBtn.innerHTML = '<i class="fas fa-trash me-2"></i>××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×';
            }
        }
    }
    // Add this function to your main app
    async function loadWeeklyOverview() {
        if (!db) return;

        try {
            const weekData = [];
            const today = new Date();

            // Get data for the last 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];

                // Get day totals and meals from database
                const [totals, meals] = await Promise.all([
                    db.getDayTotals(dateString),
                    db.getDayMeals(dateString)
                ]);

                weekData.push({
                    date: dateString,
                    dateObj: date,
                    meals: meals,
                    totalCalories: totals.calories,
                    totalCarbs: totals.carbs
                });
            }

            // Find the third page element (yesterday tab)

            const weeklyPage = document.querySelector('.page:nth-child(3)');

            if (!weeklyPage) return;

            weeklyPage.innerHTML= `
                            <div class="header">
                              <div class="container-fluid">
                                 <h1 class="h3 mb-0 text-center">
                                           ×¡×§×™×¨×” ×©×‘×•×¢×™×ª
                                 </h1>
                               </div>
                             </div>

                             <div class="container-fluid px-3">
                                <!-- Week Summary -->
                                <div class="week-summary">
                                     <div class="summary-grid" id="weekSummary">
                                        ${createWeekSummary(weekData)}
                                    </div>
                                </div>

                                <!-- Daily Cards -->
                                <div class="daily-cards" id="dailyCards">
                                    ${weekData.map((dayData, index) => createDayCard(dayData, index)).join('')}
                                </div>
                              </div>
                            `;


            console.log('âœ… Weekly overview loaded with real data');

        } catch (error) {
            console.error('âŒ Error loading weekly overview:', error);

            // Show error state
            const weeklyPage = document.querySelector('.page:nth-child(3)');
            const container = weeklyPage?.querySelector('.container-fluid');
            if (container) {
                container.innerHTML = `
                                <div class="text-center py-4 text-danger">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                    <div>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×§×™×¨×” ×”×©×‘×•×¢×™×ª</div>
                                    <small>× ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£</small>
                                </div>
                            `;
            }
        }
    }

    // Helper functions (add these to your main app)
    function getHebrewDayName(date) {
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        return days[date.getDay()];
    }

    function getHebrewMonthName(date) {
        const months = [
            '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
            '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
        ];
        return months[date.getMonth()];
    }

    function formatHebrewDate2(date, includeToday = true) {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (includeToday && date.toDateString() === today.toDateString()) {
            return '×”×™×•×';
        } else if (includeToday && date.toDateString() === yesterday.toDateString()) {
            return '××ª××•×œ';
        }

        const dayName = getHebrewDayName(date);
        const day = date.getDate();
        const month = getHebrewMonthName(date);

        return `×™×•× ${dayName}, ${day} ${month}`;
    }

    function getCalorieStatus(calories) {

        if (calories <= db.DAILY_GOAL) return 'under';
        if (calories <= db.DAILY_GOAL + 200) return 'over';
        return 'way-over';
    }

    function createDayCard(dayData, index) {

        const status = getCalorieStatus(dayData.totalCalories);
        const statusClass = status === 'under' ? '' : status === 'over' ? 'over-target' : 'way-over-target';

        const mealsHtml = dayData.meals.length === 0 ?
            '<div class="empty-day">×œ× × ×¨×©××• ××¨×•×—×•×ª ×‘×™×•× ×–×”</div>' :
            dayData.meals.map(meal => `
                            <div class="meal-entry">
                                <div class="weekday-meal-time">


                                        ${meal.time}

                                </div>
                                <span class="weekday-meal-name">${meal.mealName}</span>
                                <span class="weekday-meal-calories">  ${meal.calories}</span>

                            </div>
                        `).join('');

        return `
                        <div class="day-card" onclick="toggleDayCard(this)" data-day-index="${index}">
                            <div class="day-card-closed ${statusClass}">
                                <div class="expand-icon">
                                    <i class="fas fa-chevron-down"></i>
                                </div>


                                <div class="weekday-summary d-flex">
                                    <div class="weekday-item ${statusClass}">
                                          <div class="weekday-date"> ${formatHebrewDate2(dayData.dateObj)}</div>
                                          <strong>${dayData.totalCalories}</strong>
                                          ×§×œ×•×¨×™×•×ª ×‘-
                                          <strong>${dayData.meals.length}</strong>
                                            ××¨×•×—×•×ª
                                    </div>

                                </div>
                            </div>

                            <div class="day-details">
                                <div class="day-details-content">
                                    <div class="meals-list">
                                        ${mealsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
    }

    function createWeekSummary(weekData) {

        // Filter to only days with meals logged
        const daysWithMeals = weekData.filter(day => day.meals.length > 0);

        // Calculate metrics only for days with meals
        const greenDays = daysWithMeals.filter(day => day.totalCalories > 100 && day.totalCalories <= db.DAILY_GOAL ).length;
        const redDays = daysWithMeals.filter(day => day.totalCalories > db.DAILY_GOAL).length;

        // Average calories only for days with meals (avoid division by zero)
        const avgCalories = daysWithMeals.length > 0 ?
            Math.round(daysWithMeals.reduce((sum, day) => sum + day.totalCalories, 0) / daysWithMeals.length) : 0;

        // Total meals across all days
        const totalMeals = weekData.reduce((sum, day) => sum + day.meals.length, 0);

        return `
                        <div class="summary-item">
                            <div class="summary-number">${totalMeals}</div>
                            <div class="summary-label">××¨×•×—×•×ª</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number green-days">${greenDays}</div>
                            <div class="summary-label">×‘×˜×•×•×—</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number red-days">${redDays}</div>
                            <div class="summary-label">××¢×œ ×™×¢×“</div>
                        </div>
                         <div class="summary-item">
                            <div class="summary-number avg-calories">${avgCalories}</div>
                            <div class="summary-label">×××•×¦×¢ ×§×œ×•×¨×™×•×ª</div>
                        </div>
                    `;
    }

    function toggleDayCard(card) {
        const details = card.querySelector('.day-details');
        const icon = card.querySelector('.expand-icon i');

        if (details.classList.contains('show')) {
            details.classList.remove('show');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            card.classList.remove('expanded');
        } else {
            // Close all other cards
            document.querySelectorAll('.day-details.show').forEach(detail => {
                detail.classList.remove('show');
            });
            document.querySelectorAll('.expand-icon i').forEach(expandIcon => {
                expandIcon.classList.remove('fa-chevron-up');
                expandIcon.classList.add('fa-chevron-down');
            });
            document.querySelectorAll('.day-card.expanded').forEach(expandedCard => {
                expandedCard.classList.remove('expanded');
            });

            // Open this card
            details.classList.add('show');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            card.classList.add('expanded');
        }
    }

    async function deleteLoggedFood(logId, mealName) {
        // Show confirmation dialog
        const confirmed = confirm(
            `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¨×™×©×•×?\n\n` +
            `"${mealName}"\n\n` +
            `×¤×¢×•×œ×” ×–×• ×ª××—×§ ×¨×§ ××ª ×”×¨×™×©×•× ×”×–×” ×•×œ× ××ª ×”××¨×•×—×” ××”×¡×¤×¨×™×™×”.`
        );

        if (!confirmed) return;

        try {
            // Show loading state on delete button
            const deleteBtn = document.querySelector(`[onclick="deleteLoggedFood('${logId}', '${mealName}')"]`);
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // Delete from database
            await db.deleteLogEntry(logId);

            // Reload the current day data to refresh the UI

            await loadDayData();


            // Show success message in console
            console.log(`âœ… Deleted log entry: ${mealName}`);

        } catch (error) {
            console.error('âŒ Error deleting log entry:', error);
            alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×¨×™×©×•×. × ×¡×” ×©×•×‘.');

            // Restore button state on error
            const deleteBtn = document.querySelector(`[onclick="deleteLoggedFood('${logId}', '${mealName}')"]`);
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
    }

    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
