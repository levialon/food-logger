<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יומן תזונה</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            text-align: right;
            background-color: #f8f9fa;
            padding-bottom: 120px;
            overflow-x: hidden;
        }
        
        .app-container {
            width: 300vw;
            display: flex;
            transition: transform 0.4s ease-out;
        }
        
        .page {
            width: 100vw;
            flex-shrink: 0;
            min-height: calc(100vh - 120px);
        }
        
        .meal-card {
            transition: all 0.3s ease-in-out;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            cursor: pointer;
            overflow: hidden;
            border-radius: 12px;
            height: 100%;
        }
        
        .meal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .meal-card.expanded {
            position: absolute;
            width: calc(100vw - 2rem);
            max-width: 480px;
            left: 50%;
            transform: translateX(-50%) scale(1.02);
            z-index: 100;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            border-radius: 12px;
            background: white;
        }
        
        .card-closed {
            height: 200px;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: end;
            border-radius: 12px;
        }
        
        .card-overlay {
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            width: 100%;
            padding: 1rem;
            color: white;
            border-radius: 0 0 12px 12px;
        }
        
        .meal-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .card-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }
        
        .card-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            background: white;
        }
        
        .card-details.show {
            max-height: 500px;
        }
        
        .card-details-content {
            padding: 1rem;
        }
        
        .add-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .ingredients-text {
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        
        .stats-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-left: 0.25rem;
        }
        
        .container-fluid {
            max-width: 480px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 1rem;
        }
        
        .expand-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            color: #333;
            font-size: 0.8rem;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .search-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #f8f9fa;
            padding: 0.5rem 0;
            margin: -0.5rem 0 1rem 0;
        }
        
        .search-container .form-control {
            border-color: #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .search-container .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .search-container .input-group-text {
            border-color: #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .meal-card.hidden {
            display: none;
        }
        
        .no-results {
            text-align: center;
            color: #6c757d;
            padding: 2rem;
            font-size: 1.1rem;
        }
        
        .no-results i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }
        
        .usage-counter {
            background: rgba(255,255,255,0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            backdrop-filter: blur(5px);
        }
        
        .calories-info {
            background: rgba(255,255,255,0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            backdrop-filter: blur(5px);
        }
        
        .eat-now-btn {
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .eat-now-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        /* Bottom Tab Navigation */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            height: 70px;
        }
        
        .tabs {
            display: flex;
            height: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
            font-size: 0.75rem;
            padding: 0.5rem;
        }
        
        .tab.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }
        
        /* Daily Summary Styles */
        .daily-summary {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .date-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #495057;
        }
        
        .nutrition-summary {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 2px solid #28a745;
        }
        
        .nutrition-summary.over-goal {
            border-color: #dc3545;
        }
        
        .nutrition-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .nutrition-label {
            font-weight: 600;
            color: #495057;
        }
        
        .nutrition-value {
            font-weight: 600;
        }
        
        .nutrition-value.over-goal {
            color: #dc3545;
        }
        
        .meal-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-right: 4px solid #667eea;
        }
        
        .meal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .meal-name {
            font-weight: 600;
            color: #495057;
        }
        
        .meal-calories {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .meal-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .camera-input {
            display: none;
        }
        
        .camera-btn {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .camera-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            color: #667eea;
        }
        
        .camera-btn.has-image {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
            color: #28a745;
        }
        
        /* RTL Bootstrap fixes */
        .modal-header .btn-close {
            margin-left: auto;
            margin-right: 0;
        }
        
        .row {
            margin-left: -0.33rem;
            margin-right: -0.33rem;
        }
        
        .col-4 {
            padding-left: 0.33rem;
            padding-right: 0.33rem;
        }
        
        .d-flex.gap-2 > * {
            margin-left: 0.5rem;
        }
        
        .d-flex.gap-2 > *:first-child {
            margin-left: 0;
        }
    </style>
</head>
<body>
    <!-- App Container with 3 pages -->
    <div class="app-container" id="appContainer">
        <!-- Page 1: Meals Library -->
        <div class="page">
            <!-- Header -->
            <div class="header">
                <div class="container-fluid">
                    <h1 class="h3 mb-0 text-center">
                        <i class="fas fa-utensils me-2"></i>
                        יומן תזונה
                    </h1>
                </div>
            </div>

            <!-- Main Content -->
            <div class="container-fluid px-3">
                <!-- Search Bar -->
                <div class="search-container mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 ps-0" id="searchInput" 
                               placeholder="חפש ארוחה..." onkeyup="filterMeals()">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch" onclick="clearSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Meal Cards Grid (loaded from database) -->
                <div class="row g-2" id="mealsGrid">
                    <!-- Meals will be loaded from database -->
                
                </div>
                
                <!-- No Results Message -->
                <div id="noResultsMessage" class="no-results" style="display: none;">
                    <i class="fas fa-search"></i>
                    <div>לא נמצאו ארוחות התואמות לחיפוש</div>
                    <small>נסה לחפש במילים אחרות</small>
                </div>
            </div>
        </div>

        <!-- Page 2: Today's Summary -->
        <div class="page">
            <div class="header">
                <div class="container-fluid">
                    <h1 class="h3 mb-0 text-center">
                        <i class="fas fa-calendar-day me-2"></i>
                        היום
                    </h1>
                </div>
            </div>

            <div class="container-fluid px-3">
                <div class="daily-summary">
                    <div class="date-header">
                        <i class="fas fa-calendar me-2"></i>
                        יום ראשון, 22 יוני 2025
                    </div>
                    
                    <div class="nutrition-summary over-goal">
                        <div class="nutrition-row">
                            <span class="nutrition-label">
                                <i class="fas fa-fire me-1"></i>קלוריות
                            </span>
                            <span class="nutrition-value over-goal">1,950 / 1,700</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">
                                <i class="fas fa-seedling me-1"></i>פחמימות
                            </span>
                            <span class="nutrition-value">185 גרם</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">
                                <i class="fas fa-dumbbell me-1"></i>חלבון
                            </span>
                            <span class="nutrition-value">95 גרם</span>
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">קערת סמותי חלבון</span>
                            <span class="meal-calories">340 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>07:30 - ארוחת בוקר
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">סלט עוף בגריל</span>
                            <span class="meal-calories">420 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>13:15 - ארוחת צהריים
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">פסטה אלפרדו עם עוף</span>
                            <span class="meal-calories">720 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>19:45 - ארוחת ערב
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">יוגורט יווני עם אגוזים</span>
                            <span class="meal-calories">190 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>21:30 - חטיף
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">תפוח וחמאת בוטנים</span>
                            <span class="meal-calories">160 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>15:20 - חטיף
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">קפה עם חלב</span>
                            <span class="meal-calories">50 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>08:00 - משקה
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">בננה</span>
                            <span class="meal-calories">70 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>16:30 - חטיף
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Yesterday's Summary -->
        <div class="page">
            <div class="header">
                <div class="container-fluid">
                    <h1 class="h3 mb-0 text-center">
                        <i class="fas fa-calendar-minus me-2"></i>
                        אתמול
                    </h1>
                </div>
            </div>

            <div class="container-fluid px-3">
                <div class="daily-summary">
                    <div class="date-header">
                        <i class="fas fa-calendar me-2"></i>
                        יום שבת, 21 יוני 2025
                    </div>
                    
                    <div class="nutrition-summary">
                        <div class="nutrition-row">
                            <span class="nutrition-label">
                                <i class="fas fa-fire me-1"></i>קלוריות
                            </span>
                            <span class="nutrition-value">1,620 / 1,700</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">
                                <i class="fas fa-seedling me-1"></i>פחמימות
                            </span>
                            <span class="nutrition-value">165 גרם</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">
                                <i class="fas fa-dumbbell me-1"></i>חלבון
                            </span>
                            <span class="nutrition-value">85 גרם</span>
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">פיצה מרגריטה</span>
                            <span class="meal-calories">650 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>20:00 - ארוחת ערב
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">ראפ ירקות ים-תיכוני</span>
                            <span class="meal-calories">380 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>13:00 - ארוחת צהריים
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">ביצים מקושקשות עם טוסט</span>
                            <span class="meal-calories">320 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>08:15 - ארוחת בוקר
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">גבינת קוטג' עם מלפפון</span>
                            <span class="meal-calories">120 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>16:00 - חטיף
                        </div>
                    </div>

                    <div class="meal-item">
                        <div class="meal-item-header">
                            <span class="meal-name">שקדים מיקס</span>
                            <span class="meal-calories">150 קל'</span>
                        </div>
                        <div class="meal-time">
                            <i class="fas fa-clock me-1"></i>22:00 - חטיף
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Tab Navigation -->
    <div class="bottom-tabs">
        <ul class="tabs">
            <li class="tab active" onclick="switchTab(0)">
                <i class="fas fa-utensils"></i>
                <span>ארוחות</span>
            </li>
            <li class="tab" onclick="switchTab(1)">
                <i class="fas fa-calendar-day"></i>
                <span>היום</span>
            </li>
            <li class="tab" onclick="switchTab(2)">
                <i class="fas fa-calendar-minus"></i>
                <span>אתמול</span>
            </li>
        </ul>
    </div>

    <!-- Floating Add Button (only visible on meals page) -->
    <button class="btn btn-warning add-btn d-flex align-items-center justify-content-center" 
            id="addBtn" data-bs-toggle="modal" data-bs-target="#addMealModal">
        <i class="fas fa-plus fa-lg"></i>
    </button>

    <!-- Add Meal Modal -->
    <div class="modal fade" id="addMealModal" tabindex="-1" aria-labelledby="addMealModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addMealModalLabel">
                        <i class="fas fa-plus-circle me-2"></i>הוסף ארוחה חדשה
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="סגור"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="mealName" class="form-label">שם הארוחה</label>
                            <input type="text" class="form-control" id="mealName" placeholder="הכנס שם ארוחה">
                        </div>
                        <div class="mb-3">
                            <label for="mealImage" class="form-label">תמונת הארוחה</label>
                            <input type="file" class="camera-input" id="mealImageInput" accept="image/*" capture="environment" onchange="handleImageCapture(this)">
                            <div class="camera-btn" onclick="document.getElementById('mealImageInput').click()" id="cameraButton">
                                <div class="text-center">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <div>לחץ לצילום</div>
                                    <small>או בחר תמונה מהגלריה</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="ingredients" class="form-label">מרכיבים</label>
                            <textarea class="form-control" id="ingredients" rows="3" 
                                    placeholder="תאר את המרכיבים..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label for="calories" class="form-label">קלוריות</label>
                                <input type="number" class="form-control" id="calories" placeholder="420">
                            </div>
                            <div class="col-6">
                                <label for="carbs" class="form-label">פחמימות (גרם)</label>
                                <input type="number" class="form-control" id="carbs" placeholder="25">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" onclick="addNewMeal()">
                        <i class="fas fa-save me-1"></i>שמור ארוחה
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        let db = null;
        
        // Simple IndexedDB wrapper
        class FoodLoggerDB {
            constructor() {
                this.db = null;
                this.DAILY_GOAL = 1700;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('FoodLoggerDB', 1);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Meals store
                        if (!db.objectStoreNames.contains('meals')) {
                            const mealsStore = db.createObjectStore('meals', { keyPath: 'id' });
                            mealsStore.createIndex('usageCount', 'usageCount');
                        }
                        
                        // Daily logs store
                        if (!db.objectStoreNames.contains('dailyLogs')) {
                            const logsStore = db.createObjectStore('dailyLogs', { keyPath: 'id' });
                            logsStore.createIndex('date', 'date');
                        }
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async addMeal(name, image, ingredients, calories, carbs, protein) {
                const meal = {
                    id: `meal_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name,
                    image,
                    ingredients,
                    calories,
                    carbs,
                    protein,
                    usageCount: 0, // Start with 0 usage
                    createdAt: new Date().toISOString()
                };
                
                const store = this.db.transaction(['meals'], 'readwrite').objectStore('meals');
                return new Promise((resolve, reject) => {
                    const request = store.add(meal);
                    request.onsuccess = () => resolve(meal);
                    request.onerror = () => reject(request.error);
                });
            }

            async getMeals() {
                const store = this.db.transaction(['meals'], 'readonly').objectStore('meals');
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const meals = request.result;
                        // Sort by usage count (highest first)
                        meals.sort((a, b) => b.usageCount - a.usageCount);
                        resolve(meals);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async searchMeals(term) {
                const meals = await this.getMeals();
                return meals.filter(meal => 
                    meal.name.includes(term) || meal.ingredients.includes(term)
                );
            }

            async eatMeal(mealId) {
                const meal = await this.getMeal(mealId);
                if (!meal) throw new Error('Meal not found');
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const time = now.toTimeString().substring(0, 5);
                
                // Create log entry
                const log = {
                    id: `log_${today}_${Date.now()}`,
                    date: today,
                    mealId,
                    mealName: meal.name,
                    time,
                    calories: meal.calories,
                    carbs: meal.carbs,
                    protein: meal.protein,
                    loggedAt: now.toISOString()
                };
                
                // Update meal usage count
                meal.usageCount += 1;
                
                const transaction = this.db.transaction(['meals', 'dailyLogs'], 'readwrite');
                await new Promise((resolve, reject) => {
                    const updateMeal = transaction.objectStore('meals').put(meal);
                    const addLog = transaction.objectStore('dailyLogs').add(log);
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
                
                return log;
            }

            async getDayTotals(date) {
                const store = this.db.transaction(['dailyLogs'], 'readonly').objectStore('dailyLogs');
                const index = store.index('date');
                
                return new Promise((resolve, reject) => {
                    const request = index.getAll(date);
                    request.onsuccess = () => {
                        const logs = request.result;
                        const totals = logs.reduce((total, log) => ({
                            calories: total.calories + log.calories,
                            carbs: total.carbs + log.carbs,
                            protein: total.protein + log.protein
                        }), { calories: 0, carbs: 0, protein: 0 });
                        resolve(totals);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async getDayMeals(date) {
                const store = this.db.transaction(['dailyLogs'], 'readonly').objectStore('dailyLogs');
                const index = store.index('date');
                
                return new Promise((resolve, reject) => {
                    const request = index.getAll(date);
                    request.onsuccess = () => {
                        const logs = request.result;
                        logs.sort((a, b) => a.time.localeCompare(b.time));
                        resolve(logs);
                    };
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // Initialize database and load initial data
        async function initializeApp() {
            try {
                db = new FoodLoggerDB();
                await db.init();
                
                // Load existing meals into UI (will be empty on first run)
                await loadMealsFromDB();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        }

        // Load meals from database and display in UI
        async function loadMealsFromDB() {
            try {
                const meals = await db.getMeals();
                const mealsGrid = document.getElementById('mealsGrid');
                
                // Clear existing content
                mealsGrid.innerHTML = '';
                
                if (meals.length === 0) {
                    // Show empty state
                    mealsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">אין ארוחות עדיין</h4>
                                <p class="text-muted">לחץ על כפתור ה-+ כדי להוסיף את הארוחה הראשונה שלך</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Create meal cards
                    meals.forEach(meal => {
                        const cardHtml = createMealCard(meal);
                        mealsGrid.insertAdjacentHTML('beforeend', cardHtml);
                    });
                }
                
                console.log(`Loaded ${meals.length} meals from database`);
            } catch (error) {
                console.error('Error loading meals:', error);
            }
        }

        // Create HTML for a meal card
        function createMealCard(meal) {
            return `
                <div class="col-4">
                    <div class="meal-card" onclick="toggleCard(this)" data-meal-id="${meal.id}" data-usage="${meal.usageCount}">
                        <div class="card-closed" style="background-image: url('${meal.image}')">
                            <div class="expand-icon">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="card-overlay">
                                <h5 class="meal-title">${meal.name}</h5>
                                <div class="card-stats">
                                    <span class="calories-info">
                                        <i class="fas fa-fire me-1"></i>${meal.calories} קל'
                                    </span>
                                    <span class="usage-counter">
                                        <i class="fas fa-utensils me-1"></i>${meal.usageCount} פעמים
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div class="card-details-content">
                                <p class="ingredients-text">
                                    ${meal.ingredients}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex">
                                        <span class="badge bg-primary stats-badge">
                                            <i class="fas fa-fire me-1"></i>${meal.calories} קלוריות
                                        </span>
                                        <span class="badge bg-success stats-badge">
                                            <i class="fas fa-seedling me-1"></i>${meal.carbs} גרם פחמימות
                                        </span>
                                        <span class="badge bg-info stats-badge">
                                            <i class="fas fa-dumbbell me-1"></i>${meal.protein} גרם חלבון
                                        </span>
                                    </div>
                                    <span class="badge bg-secondary stats-badge">
                                        <i class="fas fa-utensils me-1"></i>נוצל ${meal.usageCount} פעמים
                                    </span>
                                </div>
                                <button class="btn eat-now-btn" onclick="eatNow(event, '${meal.id}', '${meal.name}', ${meal.calories})">
                                    <i class="fas fa-plus me-2"></i>אכלתי עכשיו
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Convert file to compressed base64
        function compressAndConvertImage(file, maxWidth = 400, quality = 0.7) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    // Set canvas size
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to compressed base64
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedBase64);
                };
                
                // Create object URL for the image
                img.src = URL.createObjectURL(file);
            });
        }

        // Add new meal to database
        async function addNewMeal() {
            const name = document.getElementById('mealName').value.trim();
            const ingredients = document.getElementById('ingredients').value.trim();
            const calories = parseInt(document.getElementById('calories').value) || 0;
            const carbs = parseInt(document.getElementById('carbs').value) || 0;
            const imageInput = document.getElementById('mealImageInput');
            
            if (!name) {
                alert('אנא מלא את שם הארוחה');
                return;
            }
            
            if (!ingredients) {
                alert('אנא תאר את מרכיבי הארוחה');
                return;
            }
            
            if (calories <= 0) {
                alert('אנא הכנס מספר קלוריות תקין');
                return;
            }

            try {
                // Show loading state
                const saveBtn = document.querySelector('#addMealModal .btn-primary');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>שומר...';
                saveBtn.disabled = true;
                
                let imageData = `https://picsum.photos/400/400?random=${Date.now()}`; // Default placeholder
                
                // If user selected an image, compress and convert to base64
                if (imageInput.files && imageInput.files[0]) {
                    const file = imageInput.files[0];
                    
                    // Check file size (warn if over 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        console.warn('Large image file, compressing...');
                    }
                    
                    imageData = await compressAndConvertImage(file, 400, 0.7);
                    console.log(`Image compressed from ${Math.round(file.size/1024)}KB to ${Math.round(imageData.length*0.75/1024)}KB`);
                }

                // Estimate protein based on calories (rough estimate: 20% of calories)
                const estimatedProtein = Math.round(calories * 0.2);
                
                // Add to database
                const meal = await db.addMeal(name, imageData, ingredients, calories, carbs, estimatedProtein);
                
                // Reload meals in UI
                await loadMealsFromDB();
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMealModal'));
                modal.hide();
                resetAddMealForm();
                
                // Show success message
                console.log('✅ Added new meal:', meal.name);
                
                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
            } catch (error) {
                console.error('❌ Error adding meal:', error);
                alert('שגיאה בהוספת הארוחה. נסה שוב.');
                
                // Restore button state
                const saveBtn = document.querySelector('#addMealModal .btn-primary');
                saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>שמור ארוחה';
                saveBtn.disabled = false;
            }
        }

        // Reset the add meal form
        function resetAddMealForm() {
            document.querySelector('#addMealModal form').reset();
            const cameraButton = document.getElementById('cameraButton');
            cameraButton.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-camera fa-2x mb-2"></i>
                    <div>לחץ לצילום</div>
                    <small>או בחר תמונה מהגלריה</small>
                </div>
            `;
            cameraButton.classList.remove('has-image');
        }
        
        function switchTab(pageIndex) {
            currentPage = pageIndex;
            
            // Update tab active state
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if (index === pageIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Move to the page
            const container = document.getElementById('appContainer');
            container.style.transform = `translateX(${pageIndex * 100}vw)`;
            
            // Show/hide add button based on page
            const addBtn = document.getElementById('addBtn');
            if (pageIndex === 0) {
                addBtn.style.display = 'flex';
            } else {
                addBtn.style.display = 'none';
            }
            
            // Load daily summary data for summary pages
            loadDailySummary(pageIndex);
        }
        
        function toggleCard(card) {
            const details = card.querySelector('.card-details');
            const icon = card.querySelector('.expand-icon i');
            
            // Toggle the expanded state
            if (details.classList.contains('show')) {
                details.classList.remove('show');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                card.classList.remove('expanded');
            } else {
                // Close all other cards first
                document.querySelectorAll('.card-details.show').forEach(detail => {
                    detail.classList.remove('show');
                });
                document.querySelectorAll('.expand-icon i').forEach(expandIcon => {
                    expandIcon.classList.remove('fa-chevron-up');
                    expandIcon.classList.add('fa-chevron-down');
                });
                document.querySelectorAll('.meal-card.expanded').forEach(expandedCard => {
                    expandedCard.classList.remove('expanded');
                });
                
                // Open this card
                details.classList.add('show');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                card.classList.add('expanded');
            }
        }
        
        async function eatNow(event, mealId, mealName, calories) {
            event.stopPropagation(); // Prevent card from closing
            
            if (!db) {
                console.error('Database not initialized');
                return;
            }
            
            try {
                // Show loading state
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>מוסיף...';
                btn.disabled = true;
                
                // Log the meal
                const logEntry = await db.eatMeal(mealId);
                
                // Show success state
                btn.innerHTML = '<i class="fas fa-check me-2"></i>נוסף!';
                btn.style.background = '#28a745';
                
                // Update usage count in UI by reloading meals
                await loadMealsFromDB();
                
                console.log(`✅ Logged: ${mealName} (${calories} calories) at ${logEntry.time}`);
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('❌ Error logging meal:', error);
                
                // Show error state
                const btn = event.target;
                btn.innerHTML = '<i class="fas fa-times me-2"></i>שגיאה';
                btn.style.background = '#dc3545';
                
                setTimeout(() => {
                    btn.innerHTML = `<i class="fas fa-plus me-2"></i>אכלתי עכשיו`;
                    btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    btn.disabled = false;
                }, 2000);
            }
        }
        
        async function filterMeals() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            const searchTerm = searchInput.value.trim();
            const noResultsMessage = document.getElementById('noResultsMessage');
            
            // Show/hide clear button
            if (searchTerm.length > 0) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }
            
            // Only filter after 2 characters
            if (searchTerm.length < 2) {
                // Show all meals
                await loadMealsFromDB();
                noResultsMessage.style.display = 'none';
                return;
            }
            
            try {
                // Search in database
                const meals = await db.searchMeals(searchTerm);
                const mealsGrid = document.getElementById('mealsGrid');
                
                // Clear and show results
                mealsGrid.innerHTML = '';
                
                if (meals.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                    meals.forEach(meal => {
                        const cardHtml = createMealCard(meal);
                        mealsGrid.insertAdjacentHTML('beforeend', cardHtml);
                    });
                }
            } catch (error) {
                console.error('Search error:', error);
                // Show no results if search fails
                document.getElementById('mealsGrid').innerHTML = '';
                noResultsMessage.style.display = 'block';
            }
        }
        
        async function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            searchInput.value = '';
            clearButton.style.display = 'none';
            
            // Show all meals
            await loadMealsFromDB();
            document.getElementById('noResultsMessage').style.display = 'none';
            searchInput.focus();
        }
        
        function handleImageCapture(input) {
            const button = document.getElementById('cameraButton');
            
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                button.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <div>תמונה נבחרה</div>
                        <small>${fileName}</small>
                    </div>
                `;
                button.classList.add('has-image');
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
